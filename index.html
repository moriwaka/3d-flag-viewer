
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Flag Viewer - Áâ©ÁêÜ„Éô„Éº„Çπ3DÂõΩÊóó</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        #canvas-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            cursor: move;
            touch-action: none;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            border-radius: 1rem;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .search-item-active {
            background-color: #3b82f6 !important;
            color: white;
        }
        input[type="range"] {
            accent-color: #3b82f6;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="p-6 bg-slate-900 border-b border-slate-800 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                    <span class="text-blue-500">üè≥Ô∏è‚Äçüåà</span> 3D Flag Viewer
                </h1>
                <p class="text-slate-400 text-sm mt-1">Áâ©ÁêÜ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Å´„Çà„Çã„É™„Ç¢„É´„Å™ÂõΩÊóó„É¨„É≥„ÉÄ„É©„Éº</p>
            </div>
            
            <div class="flex flex-wrap gap-2 items-center">
                <div class="relative w-64">
                    <input type="text" id="countrySearch" autocomplete="off" placeholder="ÂõΩÂêç„ÅßÊ§úÁ¥¢..." 
                           class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto custom-scrollbar"></div>
                </div>
                <button id="toggleDetailed" title="Ë©≥Á¥∞Ë®≠ÂÆö" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg transition-colors flex items-center gap-2 text-xs font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Ë©≥Á¥∞Ë®≠ÂÆö
                </button>
                <button id="captureImage" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    PNG‰øùÂ≠ò
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-6 max-w-6xl mx-auto w-full flex flex-col gap-6">
        <div class="relative group">
            <div id="canvas-container"></div>
            <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-slate-900/50 rounded-xl hidden">
                <div class="loading-spinner"></div>
            </div>
            <!-- Pause Overlay Indicator -->
            <div id="pauseIndicator" class="absolute top-4 right-4 bg-slate-900/80 px-3 py-1 rounded-full text-xs font-bold text-yellow-500 border border-yellow-500/50 flex items-center gap-2 hidden">
                <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                PAUSED
            </div>
        </div>

        <!-- Detailed Panel -->
        <div id="detailedPanel" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 animate-in slide-in-from-top duration-300">
            <div class="bg-slate-900 p-5 rounded-xl border border-blue-500/30 shadow-lg col-span-1 md:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" /></svg>
                        ÂÖâÊ∫êË®≠ÂÆö
                    </h3>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-slate-400">Âº∑Â∫¶</label>
                            <input type="range" id="lightIntensity" min="0" max="3" step="0.1" value="1.0" class="w-24 h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">ÂÖâÊ∫ê‰ΩçÁΩÆ X</label>
                        <input type="range" id="lightPosX" min="-20" max="20" step="0.5" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">ÂÖâÊ∫ê‰ΩçÁΩÆ Y</label>
                        <input type="range" id="lightPosY" min="-20" max="20" step="0.5" value="10" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-500 block mb-1">ÂÖâÊ∫ê‰ΩçÁΩÆ Z</label>
                        <input type="range" id="lightPosZ" min="-20" max="20" step="0.5" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 p-5 rounded-xl border border-blue-500/30 shadow-lg">
                <h3 class="text-sm font-bold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg>
                    „Ç´„É°„É© & Êìç‰Ωú
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">ÁîªËßí (FOV)</label>
                        <input type="range" id="cameraFOV" min="15" max="100" step="1" value="45" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="togglePlayback" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-lg text-[10px] font-semibold flex items-center justify-center gap-1 transition-colors">
                            <span id="playbackIcon">‚è∏</span>
                            <span id="playbackText">‰∏ÄÊôÇÂÅúÊ≠¢</span>
                        </button>
                        <button id="resetView" class="bg-slate-800 hover:bg-slate-700 border border-slate-700 px-3 py-2 rounded-lg text-[10px] font-semibold flex items-center justify-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                            „É™„Çª„ÉÉ„Éà
                        </button>
                    </div>
                    <button id="saveDetailedSettings" class="w-full bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-lg active:scale-95">
                        Ë®≠ÂÆö„Çí‰øùÂ≠ò
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">ÁèæÂú®„ÅÆÂõΩ</h3>
                    <button id="copyInfo" class="text-xs text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                        „Ç≥„Éî„Éº
                    </button>
                </div>
                <div id="countryInfo" class="space-y-2">
                    <p class="text-2xl font-bold" id="currentCountryName">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                    <p class="text-slate-400" id="currentCountryCode">ISO Code: --</p>
                </div>
            </div>
            
            <div class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">Áâ©ÁêÜ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">È¢®„ÅÆÂº∑„Åï</label>
                            <input type="range" id="windSpeed" min="0" max="25" step="0.5" value="10" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">È¢®„ÅÆÊè∫„Çâ„Åé</label>
                            <input type="range" id="windAmplitude" min="0" max="2" step="0.1" value="0.5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    <div class="border-t border-slate-800 pt-3">
                        <label class="text-xs text-slate-400 block mb-1 font-semibold text-blue-400">ÈáçÂäõÔºàÂ∏É„ÅÆÈáç„ÅøÔºâ</label>
                        <input type="range" id="gravityStrength" min="0" max="15" step="0.5" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="p-6 text-center text-slate-500 text-xs border-t border-slate-800 mt-auto">
        <p>Flag textures via <a href="https://flagpedia.net" target="_blank" class="underline hover:text-blue-400">Flagpedia.net</a>.</p>
    </footer>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Constants & Data ---
        const COUNTRIES = [
            { name: "„Ç¢„Ç§„Çπ„É©„É≥„Éâ", code: "is" }, { name: "„Ç¢„Ç§„É´„É©„É≥„Éâ", code: "ie" }, { name: "„Ç¢„Çº„É´„Éê„Ç§„Ç∏„É£„É≥", code: "az" }, { name: "„Ç¢„Éï„Ç¨„Éã„Çπ„Çø„É≥", code: "af" },
            { name: "„Ç¢„É°„É™„Ç´ÂêàË°ÜÂõΩ", code: "us" }, { name: "„Ç¢„É©„ÉñÈ¶ñÈï∑ÂõΩÈÄ£ÈÇ¶", code: "ae" }, { name: "„Ç¢„É´„Ç∏„Çß„É™„Ç¢", code: "dz" }, { name: "„Ç¢„É´„Çº„É≥„ÉÅ„É≥", code: "ar" },
            { name: "„Ç¢„É´„Éê„Éã„Ç¢", code: "al" }, { name: "„Ç¢„É´„É°„Éã„Ç¢", code: "am" }, { name: "„Ç¢„É≥„Ç¥„É©", code: "ao" }, { name: "„Ç¢„É≥„ÉÜ„Ç£„Ç∞„Ç¢„Éª„Éê„Éº„Éñ„Éº„ÉÄ", code: "ag" },
            { name: "„Ç¢„É≥„Éâ„É©", code: "ad" }, { name: "„Ç§„Ç®„É°„É≥", code: "ye" }, { name: "„Ç§„ÇÆ„É™„Çπ", code: "gb" }, { name: "„Ç§„Çπ„É©„Ç®„É´", code: "il" },
            { name: "„Ç§„Çø„É™„Ç¢", code: "it" }, { name: "„Ç§„É©„ÇØ", code: "iq" }, { name: "„Ç§„É©„É≥", code: "ir" }, { name: "„Ç§„É≥„Éâ", code: "in" },
            { name: "„Ç§„É≥„Éâ„Éç„Ç∑„Ç¢", code: "id" }, { name: "„Ç¶„Ç¨„É≥„ÉÄ", code: "ug" }, { name: "„Ç¶„ÇØ„É©„Ç§„Éä", code: "ua" }, { name: "„Ç¶„Ç∫„Éô„Ç≠„Çπ„Çø„É≥", code: "uz" },
            { name: "„Ç¶„É´„Ç∞„Ç¢„Ç§", code: "uy" }, { name: "„Ç®„ÇØ„Ç¢„Éâ„É´", code: "ec" }, { name: "„Ç®„Ç∏„Éó„Éà", code: "eg" }, { name: "„Ç®„Çπ„Éà„Éã„Ç¢", code: "ee" },
            { name: "„Ç®„Çπ„ÉØ„ÉÜ„Ç£„Éã", code: "sz" }, { name: "„Ç®„ÉÅ„Ç™„Éî„Ç¢", code: "et" }, { name: "„Ç®„É™„Éà„É™„Ç¢", code: "er" }, { name: "„Ç®„É´„Çµ„É´„Éê„Éâ„É´", code: "sv" },
            { name: "„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢", code: "au" }, { name: "„Ç™„Éº„Çπ„Éà„É™„Ç¢", code: "at" }, { name: "„Ç™„Éû„Éº„É≥", code: "om" }, { name: "„Ç™„É©„É≥„ÉÄ", code: "nl" },
            { name: "„Ç¨„Éº„Éä", code: "gh" }, { name: "„Ç´„Éº„Éú„Éô„É´„Éá", code: "cv" }, { name: "„Ç¨„Ç§„Ç¢„Éä", code: "gy" }, { name: "„Ç´„Ç∂„Éï„Çπ„Çø„É≥", code: "kz" },
            { name: "„Ç´„Çø„Éº„É´", code: "qa" }, { name: "„Ç´„Éä„ÉÄ", code: "ca" }, { name: "„Ç¨„Éú„É≥", code: "ga" }, { name: "„Ç´„É°„É´„Éº„É≥", code: "cm" },
            { name: "ÈüìÂõΩ", code: "kr" }, { name: "„Ç¨„É≥„Éì„Ç¢", code: "gm" }, { name: "„Ç´„É≥„Éú„Ç∏„Ç¢", code: "kh" }, { name: "Âåó„Éû„Ç±„Éâ„Éã„Ç¢", code: "mk" },
            { name: "„ÇÆ„Éã„Ç¢", code: "gn" }, { name: "„ÇÆ„Éã„Ç¢„Éì„Çµ„Ç¶", code: "gw" }, { name: "„Ç≠„Éó„É≠„Çπ", code: "cy" }, { name: "„Ç≠„É•„Éº„Éê", code: "cu" },
            { name: "„ÇÆ„É™„Ç∑„É£", code: "gr" }, { name: "„Ç≠„É™„Éê„Çπ", code: "ki" }, { name: "„Ç≠„É´„ÇÆ„Çπ", code: "kg" }, { name: "„Ç∞„Ç¢„ÉÜ„Éû„É©", code: "gt" },
            { name: "„ÇØ„Ç¶„Çß„Éº„Éà", code: "kw" }, { name: "„ÇØ„ÉÉ„ÇØË´∏Â≥∂", code: "ck" }, { name: "„Ç∞„É¨„Éä„ÉÄ", code: "gd" }, { name: "„ÇØ„É≠„Ç¢„ÉÅ„Ç¢", code: "hr" },
            { name: "„Ç±„Éã„Ç¢", code: "ke" }, { name: "„Ç≥„Éº„Éà„Ç∏„Éú„ÉØ„Éº„É´", code: "ci" }, { name: "„Ç≥„Çπ„Çø„É™„Ç´", code: "cr" }, { name: "„Ç≥„ÇΩ„Éú", code: "xk" },
            { name: "„Ç≥„É¢„É≠", code: "km" }, { name: "„Ç≥„É≠„É≥„Éì„Ç¢", code: "co" }, { name: "„Ç≥„É≥„Ç¥ÂÖ±ÂíåÂõΩ", code: "cg" }, { name: "„Ç≥„É≥„Ç¥Ê∞ë‰∏ªÂÖ±ÂíåÂõΩ", code: "cd" },
            { name: "„Çµ„Ç¶„Ç∏„Ç¢„É©„Éì„Ç¢", code: "sa" }, { name: "„Çµ„É¢„Ç¢", code: "ws" }, { name: "„Çµ„É≥„Éà„É°„Éª„Éó„É™„É≥„Ç∑„Éö", code: "st" }, { name: "„Ç∂„É≥„Éì„Ç¢", code: "zm" },
            { name: "„Çµ„É≥„Éû„É™„Éé", code: "sm" }, { name: "„Ç∑„Ç®„É©„É¨„Ç™„Éç", code: "sl" }, { name: "„Ç∏„Éñ„ÉÅ", code: "dj" }, { name: "„Ç∏„É£„Éû„Ç§„Ç´", code: "jm" },
            { name: "„Ç∏„Éß„Éº„Ç∏„Ç¢", code: "ge" }, { name: "„Ç∑„É™„Ç¢", code: "sy" }, { name: "„Ç∑„É≥„Ç¨„Éù„Éº„É´", code: "sg" }, { name: "„Ç∏„É≥„Éê„Éñ„Ç®", code: "zw" },
            { name: "„Çπ„Ç§„Çπ", code: "ch" }, { name: "„Çπ„Ç¶„Çß„Éº„Éá„É≥", code: "se" }, { name: "„Çπ„Éº„ÉÄ„É≥", code: "sd" }, { name: "„Çπ„Éö„Ç§„É≥", code: "es" },
            { name: "„Çπ„É™„Éä„É†", code: "sr" }, { name: "„Çπ„É™„É©„É≥„Ç´", code: "lk" }, { name: "„Çπ„É≠„Éê„Ç≠„Ç¢", code: "sk" }, { name: "„Çπ„É≠„Éô„Éã„Ç¢", code: "si" },
            { name: "„Çª„Éº„Ç∑„Çß„É´", code: "sc" }, { name: "Ëµ§ÈÅì„ÇÆ„Éã„Ç¢", code: "gq" }, { name: "„Çª„Éç„Ç¨„É´", code: "sn" }, { name: "„Çª„É´„Éì„Ç¢", code: "rs" },
            { name: "„Çª„É≥„Éà„ÇØ„É™„Çπ„Éà„Éï„Ç°„Éº„Éª„Éç„Ç§„Éì„Çπ", code: "kn" }, { name: "„Çª„É≥„Éà„Éì„É≥„Çª„É≥„Éà„Éª„Ç∞„É¨„Éä„Éá„Ç£„Éº„É≥", code: "vc" }, { name: "„Çª„É≥„Éà„É´„Ç∑„Ç¢", code: "lc" }, { name: "„ÇΩ„Éû„É™„Ç¢", code: "so" },
            { name: "„ÇΩ„É≠„É¢„É≥Ë´∏Â≥∂", code: "sb" }, { name: "„Çø„Ç§", code: "th" }, { name: "Âè∞Êπæ", code: "tw" }, { name: "„Çø„Ç∏„Ç≠„Çπ„Çø„É≥", code: "tj" },
            { name: "„Çø„É≥„Ç∂„Éã„Ç¢", code: "tz" }, { name: "„ÉÅ„Çß„Ç≥", code: "cz" }, { name: "„ÉÅ„É£„Éâ", code: "td" }, { name: "‰∏≠Â§Æ„Ç¢„Éï„É™„Ç´ÂÖ±ÂíåÂõΩ", code: "cf" },
            { name: "‰∏≠ÂõΩ", code: "cn" }, { name: "„ÉÅ„É•„Éã„Ç∏„Ç¢", code: "tn" }, { name: "„ÉÅ„É™", code: "cl" }, { name: "„ÉÑ„Éê„É´", code: "tv" },
            { name: "„Éá„É≥„Éû„Éº„ÇØ", code: "dk" }, { name: "„Éâ„Ç§„ÉÑ", code: "de" }, { name: "„Éà„Éº„Ç¥", code: "tg" }, { name: "„Éâ„Éü„Éã„Ç´ÂÖ±ÂíåÂõΩ", code: "do" },
            { name: "„Éâ„Éü„Éã„Ç´ÂõΩ", code: "dm" }, { name: "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥", code: "tt" }, { name: "„Éà„É´„ÇØ„É°„Éã„Çπ„Çø„É≥", code: "tm" }, { name: "„Éà„É´„Ç≥", code: "tr" },
            { name: "„Éà„É≥„Ç¨", code: "to" }, { name: "„Éä„Ç§„Ç∏„Çß„É™„Ç¢", code: "ng" }, { name: "„Éä„Ç¶„É´", code: "nr" }, { name: "„Éä„Éü„Éì„Ç¢", code: "na" },
            { name: "„Éã„Ç´„É©„Ç∞„Ç¢", code: "ni" }, { name: "„Éã„Ç∏„Çß„Éº„É´", code: "ne" }, { name: "Êó•Êú¨", code: "jp" }, { name: "„Éã„É•„Éº„Ç∏„Éº„É©„É≥„Éâ", code: "nz" },
            { name: "„Éç„Éë„Éº„É´", code: "np" }, { name: "„Éé„É´„Ç¶„Çß„Éº", code: "no" }, { name: "„Éê„Éº„É¨„Éº„É≥", code: "bh" }, { name: "„Éè„Ç§„ÉÅ", code: "ht" },
            { name: "„Éë„Ç≠„Çπ„Çø„É≥", code: "pk" }, { name: "„Éê„ÉÅ„Ç´„É≥Â∏ÇÂõΩ", code: "va" }, { name: "„Éë„Éä„Éû", code: "pa" }, { name: "„Éê„Éå„Ç¢„ÉÑ", code: "vu" },
            { name: "„Éê„Éè„Éû", code: "bs" }, { name: "„Éë„Éó„Ç¢„Éã„É•„Éº„ÇÆ„Éã„Ç¢", code: "pg" }, { name: "„Éë„É©„Ç™", code: "pw" }, { name: "„Éë„É©„Ç∞„Ç¢„Ç§", code: "py" },
            { name: "„Éê„É´„Éê„Éâ„Çπ", code: "bb" }, { name: "„Éë„É¨„Çπ„ÉÅ„Éä", code: "ps" }, { name: "„Éè„É≥„Ç¨„É™„Éº", code: "hu" }, { name: "„Éê„É≥„Ç∞„É©„Éá„Ç∑„É•", code: "bd" },
            { name: "Êù±„ÉÜ„Ç£„É¢„Éº„É´", code: "tl" }, { name: "„Éï„Ç£„Ç∏„Éº", code: "fj" }, { name: "„Éï„Ç£„É™„Éî„É≥", code: "ph" }, { name: "„Éï„Ç£„É≥„É©„É≥„Éâ", code: "fi" },
            { name: "„Éñ„Éº„Çø„É≥", code: "bt" }, { name: "„Éñ„É©„Ç∏„É´", code: "br" }, { name: "„Éï„É©„É≥„Çπ", code: "fr" }, { name: "„Éñ„É´„Ç¨„É™„Ç¢", code: "bg" },
            { name: "„Éñ„É´„Ç≠„Éä„Éï„Ç°„ÇΩ", code: "bf" }, { name: "„Éñ„É´„Éç„Ç§", code: "bn" }, { name: "„Éñ„É´„É≥„Ç∏", code: "bi" }, { name: "„Éô„Éà„Éä„É†", code: "vn" },
            { name: "„Éô„Éã„É≥", code: "bj" }, { name: "„Éô„Éç„Ç∫„Ç®„É©", code: "ve" }, { name: "„Éô„É©„É´„Éº„Ç∑", code: "by" }, { name: "„Éô„É™„Éº„Ç∫", code: "bz" },
            { name: "„Éô„É´„ÇÆ„Éº", code: "be" }, { name: "„Éö„É´„Éº", code: "pe" }, { name: "„Éù„Éº„É©„É≥„Éâ", code: "pl" }, { name: "„Éú„Çπ„Éã„Ç¢„Éª„Éò„É´„ÉÑ„Çß„Ç¥„Éì„Éä", code: "ba" },
            { name: "„Éú„ÉÑ„ÉØ„Éä", code: "bw" }, { name: "„Éú„É™„Éì„Ç¢", code: "bo" }, { name: "„Éù„É´„Éà„Ç¨„É´", code: "pt" }, { name: "„Éõ„É≥„Ç∏„É•„É©„Çπ", code: "hn" },
            { name: "„Éû„Éº„Ç∑„É£„É´Ë´∏Â≥∂", code: "mh" }, { name: "„Éû„ÉÄ„Ç¨„Çπ„Ç´„É´", code: "mg" }, { name: "„Éû„É©„Ç¶„Ç§", code: "mw" }, { name: "„Éû„É™", code: "ml" },
            { name: "„Éû„É´„Çø", code: "mt" }, { name: "„Éû„É¨„Éº„Ç∑„Ç¢", code: "my" }, { name: "„Éü„ÇØ„É≠„Éç„Ç∑„Ç¢ÈÄ£ÈÇ¶", code: "fm" }, { name: "Âçó„Ç¢„Éï„É™„Ç´", code: "za" },
            { name: "Âçó„Çπ„Éº„ÉÄ„É≥", code: "ss" }, { name: "„Éü„É£„É≥„Éû„Éº", code: "mm" }, { name: "„É°„Ç≠„Ç∑„Ç≥", code: "mx" }, { name: "„É¢„Éº„É™„Ç∑„É£„Çπ", code: "mu" },
            { name: "„É¢„Éº„É™„Çø„Éã„Ç¢", code: "mr" }, { name: "„É¢„Ç∂„É≥„Éì„Éº„ÇØ", code: "mz" }, { name: "„É¢„Éä„Ç≥", code: "mc" }, { name: "„É¢„É´„Éá„Ç£„Éñ", code: "mv" },
            { name: "„É¢„É´„Éâ„Éê", code: "md" }, { name: "„É¢„É≠„ÉÉ„Ç≥", code: "ma" }, { name: "„É¢„É≥„Ç¥„É´", code: "mn" }, { name: "„É¢„É≥„ÉÜ„Éç„Ç∞„É≠", code: "me" },
            { name: "„É®„É´„ÉÄ„É≥", code: "jo" }, { name: "„É©„Ç™„Çπ", code: "la" }, { name: "„É©„Éà„Éì„Ç¢", code: "lv" }, { name: "„É™„Éà„Ç¢„Éã„Ç¢", code: "lt" },
            { name: "„É™„Éì„Ç¢", code: "ly" }, { name: "„É™„Éí„ÉÜ„É≥„Ç∑„É•„Çø„Ç§„É≥", code: "li" }, { name: "„É™„Éô„É™„Ç¢", code: "lr" }, { name: "„É´„Éº„Éû„Éã„Ç¢", code: "ro" },
            { name: "„É´„ÇØ„Çª„É≥„Éñ„É´„ÇØ", code: "lu" }, { name: "„É´„ÉØ„É≥„ÉÄ", code: "rw" }, { name: "„É¨„ÇΩ„Éà", code: "ls" }, { name: "„É¨„Éê„Éé„É≥", code: "lb" },
            { name: "„É≠„Ç∑„Ç¢", code: "ru" }, { name: "È¶ôÊ∏Ø", code: "hk" }, { name: "„Éû„Ç´„Ç™", code: "mo" }, { name: "„Éó„Ç®„É´„Éà„É™„Ç≥", code: "pr" }
        ].sort((a, b) => a.name.localeCompare(b.name, 'ja'));

        const DEFAULT_PARAMS = { windSpeed: 10.0, windAmplitude: 0.5, gravityStrength: 5.0 };
        const DEFAULT_DETAILED = {
            lightIntensity: 1.0,
            lightPos: { x: 5, y: 10, z: 5 },
            cameraFOV: 45,
            isPaused: false
        };
        const DEFAULT_VIEW = { cameraPos: { x: 0, y: 0, z: 8 }, target: { x: 0, y: 0, z: 0 } };

        // --- State ---
        let currentCountry = JSON.parse(localStorage.getItem('last_country')) || COUNTRIES.find(c => c.code === 'jp') || COUNTRIES[0];
        let simulationParams = JSON.parse(localStorage.getItem('simulation_params')) || { ...DEFAULT_PARAMS };
        let detailedSettings = JSON.parse(localStorage.getItem('detailed_settings')) || { ...DEFAULT_DETAILED };
        let viewState = JSON.parse(localStorage.getItem('view_state')) || { ...DEFAULT_VIEW };
        let saveTimeout = null;
        let searchHighlightIndex = -1;

        // --- Physics Simulation (Verlet Integration) ---
        class Particle {
            constructor(x, y, z, invMass) {
                this.position = new THREE.Vector3(x, y, z);
                this.oldPosition = new THREE.Vector3(x, y, z);
                this.acceleration = new THREE.Vector3(0, 0, 0);
                this.invMass = invMass;
            }
            update(dt2) {
                if (this.invMass === 0) return;
                let vel = this.position.clone().sub(this.oldPosition);
                vel.multiplyScalar(0.95); // Drag
                let nextPos = this.position.clone().add(vel).add(this.acceleration.clone().multiplyScalar(dt2));
                this.oldPosition.copy(this.position);
                this.position.copy(nextPos);
                this.acceleration.set(0, 0, 0);
            }
        }

        class Constraint {
            constructor(p1, p2, distance) {
                this.p1 = p1;
                this.p2 = p2;
                this.distance = distance;
            }
            solve() {
                let diff = this.p1.position.clone().sub(this.p2.position);
                let currentDist = diff.length();
                if (currentDist === 0) return;
                let correction = diff.multiplyScalar((currentDist - this.distance) / currentDist * 0.5);
                if (this.p1.invMass !== 0) this.p1.position.sub(correction);
                if (this.p2.invMass !== 0) this.p2.position.add(correction);
            }
        }

        class Cloth {
            constructor(w, h, nx, ny) {
                this.w = w;
                this.h = h;
                this.nx = nx;
                this.ny = ny;
                this.particles = [];
                this.constraints = [];
                
                for (let j = 0; j <= ny; j++) {
                    for (let i = 0; i <= nx; i++) {
                        let x = (i / nx) * w;
                        let y = (1 - j / ny) * h - h / 2;
                        let invMass = (i === 0 && (j === 0 || j === ny)) ? 0 : 1;
                        this.particles.push(new Particle(x, y, 0, invMass));
                    }
                }

                const getParticle = (i, j) => this.particles[j * (nx + 1) + i];

                for (let j = 0; j <= ny; j++) {
                    for (let i = 0; i <= nx; i++) {
                        if (i < nx) this.constraints.push(new Constraint(getParticle(i, j), getParticle(i + 1, j), w / nx));
                        if (j < ny) this.constraints.push(new Constraint(getParticle(i, j), getParticle(i, j + 1), h / ny));
                        if (i < nx && j < ny) {
                            this.constraints.push(new Constraint(getParticle(i, j), getParticle(i + 1, j + 1), Math.sqrt((w/nx)**2 + (h/ny)**2)));
                            this.constraints.push(new Constraint(getParticle(i + 1, j), getParticle(i, j + 1), Math.sqrt((w/nx)**2 + (h/ny)**2)));
                        }
                        if (i < nx - 1) this.constraints.push(new Constraint(getParticle(i, j), getParticle(i + 2, j), (w/nx)*2));
                        if (j < ny - 1) this.constraints.push(new Constraint(getParticle(i, j), getParticle(i, j + 2), (h/ny)*2));
                    }
                }
            }
            update(dt, params) {
                let dt2 = dt * dt;
                let gravity = new THREE.Vector3(0, -params.gravityStrength, 0);
                let time = performance.now() * 0.001;

                this.particles.forEach(p => {
                    if (p.invMass === 0) return;
                    p.acceleration.add(gravity);
                    let windX = params.windSpeed * (1 + Math.sin(time * 2 + p.position.y) * params.windAmplitude);
                    let windZ = Math.cos(time * 3 + p.position.x) * params.windSpeed * params.windAmplitude;
                    p.acceleration.add(new THREE.Vector3(windX, 0, windZ));
                    p.update(dt2);
                });

                for (let i = 0; i < 8; i++) { 
                    this.constraints.forEach(c => c.solve());
                }
            }
        }

        // --- Three.js Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(detailedSettings.cameraFOV, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(viewState.cameraPos.x, viewState.cameraPos.y, viewState.cameraPos.z);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(viewState.target.x, viewState.target.y, viewState.target.z);
        controls.enableDamping = true;
        controls.update();

        controls.addEventListener('change', () => debouncedSave());

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, detailedSettings.lightIntensity);
        sunLight.position.set(detailedSettings.lightPos.x, detailedSettings.lightPos.y, detailedSettings.lightPos.z);
        sunLight.castShadow = true;
        scene.add(sunLight);

        const flagpoleGeom = new THREE.CylinderGeometry(0.08, 0.08, 8, 16);
        const flagpoleMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, metalness: 0.8, roughness: 0.2 });
        const flagpole = new THREE.Mesh(flagpoleGeom, flagpoleMat);
        flagpole.position.set(-0.1, -1, 0);
        scene.add(flagpole);

        let cloth, flagMesh, flagGeometry;
        const textureLoader = new THREE.TextureLoader();

        function syncPhysicsToBuffer() {
            if (cloth && flagGeometry) {
                const positions = flagGeometry.attributes.position.array;
                cloth.particles.forEach((p, i) => {
                    positions[i * 3] = p.position.x;
                    positions[i * 3 + 1] = p.position.y;
                    positions[i * 3 + 2] = p.position.z;
                });
                flagGeometry.attributes.position.needsUpdate = true;
                flagGeometry.computeVertexNormals();
            }
        }

        function createClothMesh(texture) {
            const aspect = texture.image.width / texture.image.height;
            const h = 3.0;
            const w = h * aspect;
            const nx = 30, ny = 20;
            
            const oldCloth = cloth;
            if (flagMesh) scene.remove(flagMesh);
            
            cloth = new Cloth(w, h, nx, ny);

            // „Åü„Çè„ÅøÔºà‰ª•Ââç„ÅÆ„Éë„Éº„ÉÜ„Ç£„ÇØ„É´Áä∂ÊÖãÔºâ„ÇíÂÜçÂà©Áî®
            if (oldCloth && oldCloth.nx === nx && oldCloth.ny === ny) {
                const scaleX = w / oldCloth.w;
                const scaleY = h / oldCloth.h;
                cloth.particles.forEach((p, i) => {
                    const oldP = oldCloth.particles[i];
                    // „Ç¢„É≥„Ç´„ÉºÔºài=0Ôºâ„ÅÆ‰ΩçÁΩÆ„ÅØÁ∂≠ÊåÅ„Åó„Å§„Å§„ÄÅ‰ªñ„Çí„Çπ„Ç±„Éº„É™„É≥„Ç∞
                    p.position.set(oldP.position.x * scaleX, oldP.position.y * scaleY, oldP.position.z);
                    p.oldPosition.copy(p.position);
                });
            }

            flagGeometry = new THREE.PlaneGeometry(w, h, nx, ny);
            const material = new THREE.MeshStandardMaterial({ 
                map: texture, 
                side: THREE.DoubleSide, 
                alphaTest: 0.5,
                roughness: 0.8,
                metalness: 0.1
            });
            flagMesh = new THREE.Mesh(flagGeometry, material);
            flagMesh.castShadow = true; flagMesh.receiveShadow = true;
            scene.add(flagMesh);

            // ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„Åß„ÇÇÊñ∞„Åó„ÅÑÁä∂ÊÖã„ÇíÂç≥ÊôÇÂèçÊò†
            syncPhysicsToBuffer();
        }

        function loadFlagTexture(code) {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            const url = `https://flagcdn.com/w1280/${code}.png`;
            textureLoader.load(url, (texture) => {
                texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                createClothMesh(texture);
                document.getElementById('loadingOverlay').classList.add('hidden');
            });
        }

        function selectCountry(code) {
            currentCountry = COUNTRIES.find(c => c.code === code);
            document.getElementById('currentCountryName').textContent = currentCountry.name;
            document.getElementById('currentCountryCode').textContent = `ISO Code: ${currentCountry.code.toUpperCase()}`;
            loadFlagTexture(code);
            searchResults.classList.add('hidden');
            searchInput.value = '';
            searchHighlightIndex = -1;
            localStorage.setItem('last_country', JSON.stringify(currentCountry));
        }

        // --- UI Logic ---
        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('simulation_params', JSON.stringify(simulationParams));
                localStorage.setItem('view_state', JSON.stringify({
                    cameraPos: { x: camera.position.x, y: camera.position.y, z: camera.position.z },
                    target: { x: controls.target.x, y: controls.target.y, z: controls.target.z }
                }));
            }, 1000);
        }

        const searchInput = document.getElementById('countrySearch');
        const searchResults = document.getElementById('searchResults');

        function updateSearchHighlights() {
            const items = searchResults.querySelectorAll('div');
            items.forEach((item, idx) => {
                if (idx === searchHighlightIndex) {
                    item.classList.add('search-item-active');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('search-item-active');
                }
            });
        }

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if (!val) { 
                searchResults.classList.add('hidden'); 
                searchHighlightIndex = -1;
                return; 
            }
            const filtered = COUNTRIES.filter(c => c.name.includes(val) || c.code.includes(val));
            searchResults.innerHTML = filtered.map((c, idx) => `<div class="px-4 py-2 hover:bg-slate-700 cursor-pointer text-sm" data-code="${c.code}" data-index="${idx}">${c.name}</div>`).join('');
            searchResults.classList.toggle('hidden', filtered.length === 0);
            searchHighlightIndex = filtered.length > 0 ? 0 : -1;
            updateSearchHighlights();
        });

        searchInput.addEventListener('keydown', (e) => {
            const items = searchResults.querySelectorAll('div');
            if (searchResults.classList.contains('hidden')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                searchHighlightIndex = (searchHighlightIndex + 1) % items.length;
                updateSearchHighlights();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                searchHighlightIndex = (searchHighlightIndex - 1 + items.length) % items.length;
                updateSearchHighlights();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (searchHighlightIndex >= 0 && items[searchHighlightIndex]) {
                    const code = items[searchHighlightIndex].dataset.code;
                    selectCountry(code);
                }
            }
        });

        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('[data-code]');
            if (item) {
                selectCountry(item.dataset.code);
            }
        });

        // Detailed Toggle
        document.getElementById('toggleDetailed').addEventListener('click', () => {
            const panel = document.getElementById('detailedPanel');
            panel.classList.toggle('hidden');
        });

        // Light Controls
        document.getElementById('lightIntensity').addEventListener('input', (e) => {
            detailedSettings.lightIntensity = parseFloat(e.target.value);
            sunLight.intensity = detailedSettings.lightIntensity;
        });
        ['X', 'Y', 'Z'].forEach(axis => {
            document.getElementById(`lightPos${axis}`).addEventListener('input', (e) => {
                detailedSettings.lightPos[axis.toLowerCase()] = parseFloat(e.target.value);
                sunLight.position[axis.toLowerCase()] = detailedSettings.lightPos[axis.toLowerCase()];
            });
        });

        // Camera FOV
        document.getElementById('cameraFOV').addEventListener('input', (e) => {
            detailedSettings.cameraFOV = parseInt(e.target.value);
            camera.fov = detailedSettings.cameraFOV;
            camera.updateProjectionMatrix();
        });

        // Playback Control
        const togglePlaybackBtn = document.getElementById('togglePlayback');
        const playbackIcon = document.getElementById('playbackIcon');
        const playbackText = document.getElementById('playbackText');
        const pauseIndicator = document.getElementById('pauseIndicator');

        function updatePlaybackUI() {
            if (detailedSettings.isPaused) {
                playbackIcon.textContent = '‚ñ∂Ô∏è';
                playbackText.textContent = 'ÂÜçÁîü„Åô„Çã';
                pauseIndicator.classList.remove('hidden');
            } else {
                playbackIcon.textContent = '‚è∏';
                playbackText.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢';
                pauseIndicator.classList.add('hidden');
            }
        }
        togglePlaybackBtn.addEventListener('click', () => {
            detailedSettings.isPaused = !detailedSettings.isPaused;
            updatePlaybackUI();
        });

        // Save Detailed Settings
        document.getElementById('saveDetailedSettings').addEventListener('click', () => {
            localStorage.setItem('detailed_settings', JSON.stringify(detailedSettings));
            alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
        });

        document.getElementById('resetView').addEventListener('click', () => {
            camera.position.set(DEFAULT_VIEW.cameraPos.x, DEFAULT_VIEW.cameraPos.y, DEFAULT_VIEW.cameraPos.z);
            controls.target.set(DEFAULT_VIEW.target.x, DEFAULT_VIEW.target.y, DEFAULT_VIEW.target.z);
            camera.fov = DEFAULT_DETAILED.cameraFOV;
            camera.updateProjectionMatrix();
            controls.update();
            debouncedSave();
        });

        document.getElementById('captureImage').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `flag-${currentCountry.code}.png`;
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();
        });

        document.getElementById('copyInfo').addEventListener('click', () => {
            navigator.clipboard.writeText(`${currentCountry.name} (${currentCountry.code.toUpperCase()})\nhttps://flagcdn.com/${currentCountry.code}.png`);
        });

        ['windSpeed', 'windAmplitude', 'gravityStrength'].forEach(id => {
            const el = document.getElementById(id);
            el.value = simulationParams[id];
            el.addEventListener('input', (e) => {
                simulationParams[id] = parseFloat(e.target.value);
                debouncedSave();
            });
        });

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        // --- Main Loop ---
        function animate() {
            requestAnimationFrame(animate);
            if (!detailedSettings.isPaused && cloth && flagGeometry) {
                cloth.update(0.016, simulationParams);
                syncPhysicsToBuffer();
            }
            controls.update();
            renderer.render(scene, camera);
        }

        // Init
        document.getElementById('currentCountryName').textContent = currentCountry.name;
        document.getElementById('currentCountryCode').textContent = `ISO Code: ${currentCountry.code.toUpperCase()}`;
        document.getElementById('lightIntensity').value = detailedSettings.lightIntensity;
        document.getElementById('lightPosX').value = detailedSettings.lightPos.x;
        document.getElementById('lightPosY').value = detailedSettings.lightPos.y;
        document.getElementById('lightPosZ').value = detailedSettings.lightPos.z;
        document.getElementById('cameraFOV').value = detailedSettings.cameraFOV;
        updatePlaybackUI();
        loadFlagTexture(currentCountry.code);
        animate();
    </script>
</body>
</html>
