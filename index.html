
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Flag Viewer - ÂõΩÊóó3D„É¨„É≥„ÉÄ„É©„Éº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            overflow-x: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        #canvas-container {
            width: 100%;
            height: 60vh;
            min-height: 400px;
            cursor: move;
            touch-action: none;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            border-radius: 1rem;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .search-item-active {
            background-color: #3b82f6 !important;
            color: white;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="p-6 bg-slate-900 border-b border-slate-800 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white flex items-center gap-2">
                    <span class="text-blue-500">üè≥Ô∏è‚Äçüåà</span> 3D Flag Viewer
                </h1>
                <p class="text-slate-400 text-sm mt-1">ÂõΩ„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„É™„Ç¢„É´„Å™3D„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅßÂõΩÊóó„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇ</p>
            </div>
            
            <div class="flex flex-wrap gap-2 items-center">
                <div class="relative w-64">
                    <input type="text" id="countrySearch" autocomplete="off" placeholder="ÂõΩÂêç„ÅßÊ§úÁ¥¢ (‚Üë‚Üì„ÅßÈÅ∏Êäû, Enter„ÅßÊ±∫ÂÆö)" 
                           class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg border border-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-1 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto custom-scrollbar">
                        <!-- Search items will be injected here -->
                    </div>
                </div>
                <button id="resetView" title="Ë¶ñÁÇπ„Çí„É™„Çª„ÉÉ„Éà" class="bg-slate-700 hover:bg-slate-600 p-2 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                </button>
                <button id="captureImage" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    „Ç≠„É£„Éó„ÉÅ„É£
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow p-6 max-w-6xl mx-auto w-full flex flex-col gap-6">
        <div class="relative group">
            <div id="canvas-container"></div>
            <div id="loadingOverlay" class="absolute inset-0 flex items-center justify-center bg-slate-900/50 rounded-xl hidden">
                <div class="loading-spinner"></div>
            </div>
            <div class="absolute bottom-4 left-4 text-xs text-slate-500 pointer-events-none group-hover:opacity-100 opacity-50 transition-opacity flex items-center gap-2">
                <kbd class="bg-slate-800 px-1 rounded border border-slate-700">„Éâ„É©„ÉÉ„Ç∞</kbd> ÂõûËª¢
                <kbd class="bg-slate-800 px-1 rounded border border-slate-700 ml-2">„Çπ„ÇØ„É≠„Éº„É´</kbd> „Ç∫„Éº„É†
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg">
                <div class="flex justify-between items-start mb-3">
                    <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider">ÁèæÂú®„ÅÆÂõΩ</h3>
                    <button id="copyInfo" class="text-xs text-blue-400 hover:text-blue-300 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                        Ë©≥Á¥∞„Ç≥„Éî„Éº
                    </button>
                </div>
                <div id="countryInfo" class="space-y-2">
                    <p class="text-2xl font-bold" id="currentCountryName">Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                    <p class="text-slate-400" id="currentCountryCode">ISO Code: --</p>
                </div>
            </div>
            
            <div class="bg-slate-900 p-5 rounded-xl border border-slate-800 shadow-lg">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">Áâ©ÁêÜ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">È¢®„ÅÆÂº∑„Åï</label>
                            <input type="range" id="windSpeed" min="0" max="10" step="0.1" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 block mb-1">È¢®„ÅÆÊåØÂπÖ</label>
                            <input type="range" id="windAmplitude" min="0" max="1" step="0.05" value="0.2" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                    <div class="border-t border-slate-800 pt-3">
                        <label class="text-xs text-slate-400 block mb-1 font-semibold text-blue-400">ÈáçÂäõ„ÅÆ„Äå„Åü„Çè„Åø„ÄçÂº∑Â∫¶</label>
                        <input type="range" id="gravityStrength" min="0" max="2" step="0.05" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>„Å™„Åó (Ê∞¥Âπ≥)</span>
                            <span>Âº∑„ÅÑ (ÂûÇ„Çå‰∏ã„Åå„Çä)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="p-6 text-center text-slate-500 text-xs border-t border-slate-800 mt-auto">
        <p>Flag textures provided by <a href="https://flagpedia.net" target="_blank" class="underline hover:text-blue-400">Flagpedia.net</a>.</p>
        <p class="mt-1">&copy; 2024 3D Flag Viewer. Built with Three.js & Tailwind.</p>
    </footer>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const COUNTRIES = [
            { name: "„Ç¢„Ç§„Çπ„É©„É≥„Éâ", code: "is" }, { name: "„Ç¢„Ç§„É´„É©„É≥„Éâ", code: "ie" }, { name: "„Ç¢„Çº„É´„Éê„Ç§„Ç∏„É£„É≥", code: "az" }, { name: "„Ç¢„Éï„Ç¨„Éã„Çπ„Çø„É≥", code: "af" },
            { name: "„Ç¢„É°„É™„Ç´ÂêàË°ÜÂõΩ", code: "us" }, { name: "„Ç¢„É©„ÉñÈ¶ñÈï∑ÂõΩÈÄ£ÈÇ¶", code: "ae" }, { name: "„Ç¢„É´„Ç∏„Çß„É™„Ç¢", code: "dz" }, { name: "„Ç¢„É´„Çº„É≥„ÉÅ„É≥", code: "ar" },
            { name: "„Ç¢„É´„Éê„Éã„Ç¢", code: "al" }, { name: "„Ç¢„É´„É°„Éã„Ç¢", code: "am" }, { name: "„Ç¢„É≥„Ç¥„É©", code: "ao" }, { name: "„Ç¢„É≥„ÉÜ„Ç£„Ç∞„Ç¢„Éª„Éê„Éº„Éñ„Éº„ÉÄ", code: "ag" },
            { name: "„Ç¢„É≥„Éâ„É©", code: "ad" }, { name: "„Ç§„Ç®„É°„É≥", code: "ye" }, { name: "„Ç§„ÇÆ„É™„Çπ", code: "gb" }, { name: "„Ç§„Çπ„É©„Ç®„É´", code: "il" },
            { name: "„Ç§„Çø„É™„Ç¢", code: "it" }, { name: "„Ç§„É©„ÇØ", code: "iq" }, { name: "„Ç§„É©„É≥", code: "ir" }, { name: "„Ç§„É≥„Éâ", code: "in" },
            { name: "„Ç§„É≥„Éâ„Éç„Ç∑„Ç¢", code: "id" }, { name: "„Ç¶„Ç¨„É≥„ÉÄ", code: "ug" }, { name: "„Ç¶„ÇØ„É©„Ç§„Éä", code: "ua" }, { name: "„Ç¶„Ç∫„Éô„Ç≠„Çπ„Çø„É≥", code: "uz" },
            { name: "„Ç¶„É´„Ç∞„Ç¢„Ç§", code: "uy" }, { name: "„Ç®„ÇØ„Ç¢„Éâ„É´", code: "ec" }, { name: "„Ç®„Ç∏„Éó„Éà", code: "eg" }, { name: "„Ç®„Çπ„Éà„Éã„Ç¢", code: "ee" },
            { name: "„Ç®„Çπ„ÉØ„ÉÜ„Ç£„Éã", code: "sz" }, { name: "„Ç®„ÉÅ„Ç™„Éî„Ç¢", code: "et" }, { name: "„Ç®„É™„Éà„É™„Ç¢", code: "er" }, { name: "„Ç®„É´„Çµ„É´„Éê„Éâ„É´", code: "sv" },
            { name: "„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢", code: "au" }, { name: "„Ç™„Éº„Çπ„Éà„É™„Ç¢", code: "at" }, { name: "„Ç™„Éû„Éº„É≥", code: "om" }, { name: "„Ç™„É©„É≥„ÉÄ", code: "nl" },
            { name: "„Ç¨„Éº„Éä", code: "gh" }, { name: "„Ç´„Éº„Éú„Éô„É´„Éá", code: "cv" }, { name: "„Ç¨„Ç§„Ç¢„Éä", code: "gy" }, { name: "„Ç´„Ç∂„Éï„Çπ„Çø„É≥", code: "kz" },
            { name: "„Ç´„Çø„Éº„É´", code: "qa" }, { name: "„Ç´„Éä„ÉÄ", code: "ca" }, { name: "„Ç¨„Éú„É≥", code: "ga" }, { name: "„Ç´„É°„É´„Éº„É≥", code: "cm" },
            { name: "ÈüìÂõΩ", code: "kr" }, { name: "„Ç¨„É≥„Éì„Ç¢", code: "gm" }, { name: "„Ç´„É≥„Éú„Ç∏„Ç¢", code: "kh" }, { name: "Âåó„Éû„Ç±„Éâ„Éã„Ç¢", code: "mk" },
            { name: "„ÇÆ„Éã„Ç¢", code: "gn" }, { name: "„ÇÆ„Éã„Ç¢„Éì„Çµ„Ç¶", code: "gw" }, { name: "„Ç≠„Éó„É≠„Çπ", code: "cy" }, { name: "„Ç≠„É•„Éº„Éê", code: "cu" },
            { name: "„ÇÆ„É™„Ç∑„É£", code: "gr" }, { name: "„Ç≠„É™„Éê„Çπ", code: "ki" }, { name: "„Ç≠„É´„ÇÆ„Çπ", code: "kg" }, { name: "„Ç∞„Ç¢„ÉÜ„Éû„É©", code: "gt" },
            { name: "„ÇØ„Ç¶„Çß„Éº„Éà", code: "kw" }, { name: "„ÇØ„ÉÉ„ÇØË´∏Â≥∂", code: "ck" }, { name: "„Ç∞„É¨„Éä„ÉÄ", code: "gd" }, { name: "„ÇØ„É≠„Ç¢„ÉÅ„Ç¢", code: "hr" },
            { name: "„Ç±„Éã„Ç¢", code: "ke" }, { name: "„Ç≥„Éº„Éà„Ç∏„Éú„ÉØ„Éº„É´", code: "ci" }, { name: "„Ç≥„Çπ„Çø„É™„Ç´", code: "cr" }, { name: "„Ç≥„ÇΩ„Éú", code: "xk" },
            { name: "„Ç≥„É¢„É≠", code: "km" }, { name: "„Ç≥„É≠„É≥„Éì„Ç¢", code: "co" }, { name: "„Ç≥„É≥„Ç¥ÂÖ±ÂíåÂõΩ", code: "cg" }, { name: "„Ç≥„É≥„Ç¥Ê∞ë‰∏ªÂÖ±ÂíåÂõΩ", code: "cd" },
            { name: "„Çµ„Ç¶„Ç∏„Ç¢„É©„Éì„Ç¢", code: "sa" }, { name: "„Çµ„É¢„Ç¢", code: "ws" }, { name: "„Çµ„É≥„Éà„É°„Éª„Éó„É™„É≥„Ç∑„Éö", code: "st" }, { name: "„Ç∂„É≥„Éì„Ç¢", code: "zm" },
            { name: "„Çµ„É≥„Éû„É™„Éé", code: "sm" }, { name: "„Ç∑„Ç®„É©„É¨„Ç™„Éç", code: "sl" }, { name: "„Ç∏„Éñ„ÉÅ", code: "dj" }, { name: "„Ç∏„É£„Éû„Ç§„Ç´", code: "jm" },
            { name: "„Ç∏„Éß„Éº„Ç∏„Ç¢", code: "ge" }, { name: "„Ç∑„É™„Ç¢", code: "sy" }, { name: "„Ç∑„É≥„Ç¨„Éù„Éº„É´", code: "sg" }, { name: "„Ç∏„É≥„Éê„Éñ„Ç®", code: "zw" },
            { name: "„Çπ„Ç§„Çπ", code: "ch" }, { name: "„Çπ„Ç¶„Çß„Éº„Éá„É≥", code: "se" }, { name: "„Çπ„Éº„ÉÄ„É≥", code: "sd" }, { name: "„Çπ„Éö„Ç§„É≥", code: "es" },
            { name: "„Çπ„É™„Éä„É†", code: "sr" }, { name: "„Çπ„É™„É©„É≥„Ç´", code: "lk" }, { name: "„Çπ„É≠„Éê„Ç≠„Ç¢", code: "sk" }, { name: "„Çπ„É≠„Éô„Éã„Ç¢", code: "si" },
            { name: "„Çª„Éº„Ç∑„Çß„É´", code: "sc" }, { name: "Ëµ§ÈÅì„ÇÆ„Éã„Ç¢", code: "gq" }, { name: "„Çª„Éç„Ç¨„É´", code: "sn" }, { name: "„Çª„É´„Éì„Ç¢", code: "rs" },
            { name: "„Çª„É≥„Éà„ÇØ„É™„Çπ„Éà„Éï„Ç°„Éº„Éª„Éç„Ç§„Éì„Çπ", code: "kn" }, { name: "„Çª„É≥„Éà„Éì„É≥„Çª„É≥„Éà„Éª„Ç∞„É¨„Éä„Éá„Ç£„Éº„É≥", code: "vc" }, { name: "„Çª„É≥„Éà„É´„Ç∑„Ç¢", code: "lc" }, { name: "„ÇΩ„Éû„É™„Ç¢", code: "so" },
            { name: "„ÇΩ„É≠„É¢„É≥Ë´∏Â≥∂", code: "sb" }, { name: "„Çø„Ç§", code: "th" }, { name: "Âè∞Êπæ", code: "tw" }, { name: "„Çø„Ç∏„Ç≠„Çπ„Çø„É≥", code: "tj" },
            { name: "„Çø„É≥„Ç∂„Éã„Ç¢", code: "tz" }, { name: "„ÉÅ„Çß„Ç≥", code: "cz" }, { name: "„ÉÅ„É£„Éâ", code: "td" }, { name: "‰∏≠Â§Æ„Ç¢„Éï„É™„Ç´ÂÖ±ÂíåÂõΩ", code: "cf" },
            { name: "‰∏≠ÂõΩ", code: "cn" }, { name: "„ÉÅ„É•„Éã„Ç∏„Ç¢", code: "tn" }, { name: "„ÉÅ„É™", code: "cl" }, { name: "„ÉÑ„Éê„É´", code: "tv" },
            { name: "„Éá„É≥„Éû„Éº„ÇØ", code: "dk" }, { name: "„Éâ„Ç§„ÉÑ", code: "de" }, { name: "„Éà„Éº„Ç¥", code: "tg" }, { name: "„Éâ„Éü„Éã„Ç´ÂÖ±ÂíåÂõΩ", code: "do" },
            { name: "„Éâ„Éü„Éã„Ç´ÂõΩ", code: "dm" }, { name: "„Éà„É™„Éã„ÉÄ„Éº„Éâ„Éª„Éà„Éê„Ç¥", code: "tt" }, { name: "„Éà„É´„ÇØ„É°„Éã„Çπ„Çø„É≥", code: "tm" }, { name: "„Éà„É´„Ç≥", code: "tr" },
            { name: "„Éà„É≥„Ç¨", code: "to" }, { name: "„Éä„Ç§„Ç∏„Çß„É™„Ç¢", code: "ng" }, { name: "„Éä„Ç¶„É´", code: "nr" }, { name: "„Éä„Éü„Éì„Ç¢", code: "na" },
            { name: "„Éã„Ç´„É©„Ç∞„Ç¢", code: "ni" }, { name: "„Éã„Ç∏„Çß„Éº„É´", code: "ne" }, { name: "Êó•Êú¨", code: "jp" }, { name: "„Éã„É•„Éº„Ç∏„Éº„É©„É≥„Éâ", code: "nz" },
            { name: "„Éç„Éë„Éº„É´", code: "np" }, { name: "„Éé„É´„Ç¶„Çß„Éº", code: "no" }, { name: "„Éê„Éº„É¨„Éº„É≥", code: "bh" }, { name: "„Éè„Ç§„ÉÅ", code: "ht" },
            { name: "„Éë„Ç≠„Çπ„Çø„É≥", code: "pk" }, { name: "„Éê„ÉÅ„Ç´„É≥Â∏ÇÂõΩ", code: "va" }, { name: "„Éë„Éä„Éû", code: "pa" }, { name: "„Éê„Éå„Ç¢„ÉÑ", code: "vu" },
            { name: "„Éê„Éè„Éû", code: "bs" }, { name: "„Éë„Éó„Ç¢„Éã„É•„Éº„ÇÆ„Éã„Ç¢", code: "pg" }, { name: "„Éë„É©„Ç™", code: "pw" }, { name: "„Éë„É©„Ç∞„Ç¢„Ç§", code: "py" },
            { name: "„Éê„É´„Éê„Éâ„Çπ", code: "bb" }, { name: "„Éë„É¨„Çπ„ÉÅ„Éä", code: "ps" }, { name: "„Éè„É≥„Ç¨„É™„Éº", code: "hu" }, { name: "„Éê„É≥„Ç∞„É©„Éá„Ç∑„É•", code: "bd" },
            { name: "Êù±„ÉÜ„Ç£„É¢„Éº„É´", code: "tl" }, { name: "„Éï„Ç£„Ç∏„Éº", code: "fj" }, { name: "„Éï„Ç£„É™„Éî„É≥", code: "ph" }, { name: "„Éï„Ç£„É≥„É©„É≥„Éâ", code: "fi" },
            { name: "„Éñ„Éº„Çø„É≥", code: "bt" }, { name: "„Éñ„É©„Ç∏„É´", code: "br" }, { name: "„Éï„É©„É≥„Çπ", code: "fr" }, { name: "„Éñ„É´„Ç¨„É™„Ç¢", code: "bg" },
            { name: "„Éñ„É´„Ç≠„Éä„Éï„Ç°„ÇΩ", code: "bf" }, { name: "„Éñ„É´„Éç„Ç§", code: "bn" }, { name: "„Éñ„É´„É≥„Ç∏", code: "bi" }, { name: "„Éô„Éà„Éä„É†", code: "vn" },
            { name: "„Éô„Éã„É≥", code: "bj" }, { name: "„Éô„Éç„Ç∫„Ç®„É©", code: "ve" }, { name: "„Éô„É©„É´„Éº„Ç∑", code: "by" }, { name: "„Éô„É™„Éº„Ç∫", code: "bz" },
            { name: "„Éô„É´„ÇÆ„Éº", code: "be" }, { name: "„Éö„É´„Éº", code: "pe" }, { name: "„Éù„Éº„É©„É≥„Éâ", code: "pl" }, { name: "„Éú„Çπ„Éã„Ç¢„Éª„Éò„É´„ÉÑ„Çß„Ç¥„Éì„Éä", code: "ba" },
            { name: "„Éú„ÉÑ„ÉØ„Éä", code: "bw" }, { name: "„Éú„É™„Éì„Ç¢", code: "bo" }, { name: "„Éù„É´„Éà„Ç¨„É´", code: "pt" }, { name: "„Éõ„É≥„Ç∏„É•„É©„Çπ", code: "hn" },
            { name: "„Éû„Éº„Ç∑„É£„É´Ë´∏Â≥∂", code: "mh" }, { name: "„Éû„ÉÄ„Ç¨„Çπ„Ç´„É´", code: "mg" }, { name: "„Éû„É©„Ç¶„Ç§", code: "mw" }, { name: "„Éû„É™", code: "ml" },
            { name: "„Éû„É´„Çø", code: "mt" }, { name: "„Éû„É¨„Éº„Ç∑„Ç¢", code: "my" }, { name: "„Éü„ÇØ„É≠„Éç„Ç∑„Ç¢ÈÄ£ÈÇ¶", code: "fm" }, { name: "Âçó„Ç¢„Éï„É™„Ç´", code: "za" },
            { name: "Âçó„Çπ„Éº„ÉÄ„É≥", code: "ss" }, { name: "„Éü„É£„É≥„Éû„Éº", code: "mm" }, { name: "„É°„Ç≠„Ç∑„Ç≥", code: "mx" }, { name: "„É¢„Éº„É™„Ç∑„É£„Çπ", code: "mu" },
            { name: "„É¢„Éº„É™„Çø„Éã„Ç¢", code: "mr" }, { name: "„É¢„Ç∂„É≥„Éì„Éº„ÇØ", code: "mz" }, { name: "„É¢„Éä„Ç≥", code: "mc" }, { name: "„É¢„É´„Éá„Ç£„Éñ", code: "mv" },
            { name: "„É¢„É´„Éâ„Éê", code: "md" }, { name: "„É¢„É≠„ÉÉ„Ç≥", code: "ma" }, { name: "„É¢„É≥„Ç¥„É´", code: "mn" }, { name: "„É¢„É≥„ÉÜ„Éç„Ç∞„É≠", code: "me" },
            { name: "„É®„É´„ÉÄ„É≥", code: "jo" }, { name: "„É©„Ç™„Çπ", code: "la" }, { name: "„É©„Éà„Éì„Ç¢", code: "lv" }, { name: "„É™„Éà„Ç¢„Éã„Ç¢", code: "lt" },
            { name: "„É™„Éì„Ç¢", code: "ly" }, { name: "„É™„Éí„ÉÜ„É≥„Ç∑„É•„Çø„Ç§„É≥", code: "li" }, { name: "„É™„Éô„É™„Ç¢", code: "lr" }, { name: "„É´„Éº„Éû„Éã„Ç¢", code: "ro" },
            { name: "„É´„ÇØ„Çª„É≥„Éñ„É´„ÇØ", code: "lu" }, { name: "„É´„ÉØ„É≥„ÉÄ", code: "rw" }, { name: "„É¨„ÇΩ„Éà", code: "ls" }, { name: "„É¨„Éê„Éé„É≥", code: "lb" },
            { name: "„É≠„Ç∑„Ç¢", code: "ru" }
        ].sort((a, b) => a.name.localeCompare(b.name, 'ja'));

        // Defaults
        const DEFAULT_PARAMS = {
            windSpeed: 5.0,
            windAmplitude: 0.2,
            gravityStrength: 0.0
        };

        const DEFAULT_VIEW = {
            cameraPos: { x: 0, y: 0, z: 8 },
            target: { x: 0, y: 0, z: 0 }
        };

        let currentCountry = JSON.parse(localStorage.getItem('last_country')) || COUNTRIES.find(c => c.code === 'jp') || COUNTRIES[0];
        let simulationParams = JSON.parse(localStorage.getItem('simulation_params')) || { ...DEFAULT_PARAMS };
        let viewState = JSON.parse(localStorage.getItem('view_state')) || { ...DEFAULT_VIEW };

        const searchInput = document.getElementById('countrySearch');
        const searchResults = document.getElementById('searchResults');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let filteredCountries = [];
        let focusIndex = -1;
        let saveTimeout = null;

        function updateUI() {
            document.getElementById('currentCountryName').textContent = currentCountry.name;
            document.getElementById('currentCountryCode').textContent = `ISO Code: ${currentCountry.code.toUpperCase()}`;
            localStorage.setItem('last_country', JSON.stringify(currentCountry));
            
            document.getElementById('windSpeed').value = simulationParams.windSpeed;
            document.getElementById('windAmplitude').value = simulationParams.windAmplitude;
            document.getElementById('gravityStrength').value = simulationParams.gravityStrength;

            try {
                window.location.hash = currentCountry.code;
            } catch (e) {
                console.warn("Unable to set location.hash:", e);
            }
        }

        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                localStorage.setItem('simulation_params', JSON.stringify(simulationParams));
                
                // Capture current view state
                if (camera && controls) {
                    viewState = {
                        cameraPos: { x: camera.position.x, y: camera.position.y, z: camera.position.z },
                        target: { x: controls.target.x, y: controls.target.y, z: controls.target.z }
                    };
                    localStorage.setItem('view_state', JSON.stringify(viewState));
                }
            }, 1000);
        }

        try {
            const hashValue = window.location.hash.replace('#', '').toLowerCase();
            if (hashValue) {
                const found = COUNTRIES.find(c => c.code === hashValue);
                if (found) currentCountry = found;
            }
        } catch (e) {
            console.warn("Unable to read location.hash:", e);
        }

        function renderSearchResults() {
            if (filteredCountries.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }
            searchResults.innerHTML = filteredCountries.map((c, i) => `
                <div class="px-4 py-2 hover:bg-slate-700 cursor-pointer text-sm transition-colors ${i === focusIndex ? 'search-item-active' : ''}" data-code="${c.code}">
                    <span class="font-bold">${c.name}</span> (${c.code.toUpperCase()})
                </div>
            `).join('');
            searchResults.classList.remove('hidden');
            
            const activeItem = searchResults.children[focusIndex];
            if (activeItem) {
                activeItem.scrollIntoView({ block: 'nearest' });
            }
        }

        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if (!val) { 
                searchResults.classList.add('hidden'); 
                filteredCountries = [];
                focusIndex = -1;
                return; 
            }
            filteredCountries = COUNTRIES.filter(c => c.name.toLowerCase().includes(val) || c.code.toLowerCase().includes(val));
            focusIndex = filteredCountries.length > 0 ? 0 : -1;
            renderSearchResults();
        });

        searchInput.addEventListener('keydown', (e) => {
            if (filteredCountries.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                focusIndex = (focusIndex + 1) % filteredCountries.length;
                renderSearchResults();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                focusIndex = (focusIndex - 1 + filteredCountries.length) % filteredCountries.length;
                renderSearchResults();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (focusIndex >= 0 && focusIndex < filteredCountries.length) {
                    selectCountry(filteredCountries[focusIndex]);
                }
            } else if (e.key === 'Escape') {
                searchResults.classList.add('hidden');
                focusIndex = -1;
            }
        });

        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('[data-code]');
            if (item) {
                const code = item.getAttribute('data-code');
                const found = COUNTRIES.find(c => c.code === code);
                if (found) selectCountry(found);
            }
        });

        function selectCountry(country) {
            currentCountry = country;
            updateUI();
            loadFlagTexture(country.code);
            searchResults.classList.add('hidden');
            searchInput.value = '';
            focusIndex = -1;
            filteredCountries = [];
        }

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('hidden');
            }
        });

        document.getElementById('windSpeed').addEventListener('input', (e) => { 
            simulationParams.windSpeed = parseFloat(e.target.value); 
            debouncedSave();
        });
        document.getElementById('windAmplitude').addEventListener('input', (e) => { 
            simulationParams.windAmplitude = parseFloat(e.target.value); 
            debouncedSave();
        });
        document.getElementById('gravityStrength').addEventListener('input', (e) => { 
            simulationParams.gravityStrength = parseFloat(e.target.value); 
            debouncedSave();
        });

        document.getElementById('copyInfo').addEventListener('click', () => {
            const info = `Country: ${currentCountry.name}\nISO Code: ${currentCountry.code.toUpperCase()}\nFlag API: https://flagcdn.com/w1280/${currentCountry.code}.png`;
            navigator.clipboard.writeText(info).then(() => { alert('Ë©≥Á¥∞ÊÉÖÂ†±„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ'); });
        });
        
        document.getElementById('captureImage').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `flag-${currentCountry.code}.png`;
            link.href = renderer.domElement.toDataURL('image/png');
            link.click();
        });

        document.getElementById('resetView').addEventListener('click', () => {
            camera.position.set(DEFAULT_VIEW.cameraPos.x, DEFAULT_VIEW.cameraPos.y, DEFAULT_VIEW.cameraPos.z);
            controls.target.set(DEFAULT_VIEW.target.x, DEFAULT_VIEW.target.y, DEFAULT_VIEW.target.z);
            controls.update();
            debouncedSave();
        });

        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        
        // Apply saved or default view
        camera.position.set(viewState.cameraPos.x, viewState.cameraPos.y, viewState.cameraPos.z);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(viewState.target.x, viewState.target.y, viewState.target.z);
        controls.enableDamping = true;
        controls.minDistance = 4;
        controls.maxDistance = 15;
        controls.update();

        // Listen for view changes to save state
        controls.addEventListener('change', () => {
            debouncedSave();
        });

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        const textureLoader = new THREE.TextureLoader();
        let flagMaterial;
        let flagMesh;

        const flagpoleGeom = new THREE.CylinderGeometry(0.08, 0.08, 8, 32);
        const flagpoleMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8, roughness: 0.2 });
        const flagpole = new THREE.Mesh(flagpoleGeom, flagpoleMat);
        flagpole.position.set(-2.55, -1, 0);
        scene.add(flagpole);

        function createFlagMaterial(texture) {
            return new THREE.ShaderMaterial({
                uniforms: {
                    uTexture: { value: texture },
                    uTime: { value: 0 },
                    uWindSpeed: { value: 5.0 },
                    uWindAmplitude: { value: 0.2 },
                    uGravity: { value: 0.0 }
                },
                vertexShader: `
                    uniform float uTime;
                    uniform float uWindSpeed;
                    uniform float uWindAmplitude;
                    uniform float uGravity;
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        vec3 pos = position;
                        
                        float pinFactor = smoothstep(0.0, 0.3, uv.x);
                        float wave = sin(pos.x * 1.5 - uTime * uWindSpeed) * uWindAmplitude;
                        pos.z += wave * pinFactor;
                        pos.z += sin(pos.y * 2.5 + uTime * uWindSpeed * 0.4) * uWindAmplitude * 0.4 * pinFactor;
                        
                        // Gravity Sagging
                        float weightByPosition = 0.7 + 0.3 * (1.0 - uv.y);
                        float sagAmount = uGravity * pow(uv.x, 2.0) * weightByPosition;
                        pos.y -= sagAmount;
                        pos.x -= sagAmount * 0.15 * uv.x;
                        pos.z += sin(uv.y * 6.0 + uv.x * 3.0) * sagAmount * 0.6 * pinFactor;
                        
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(pos, 1.0);
                    }
                `,
                fragmentShader: `
                    uniform sampler2D uTexture;
                    varying vec2 vUv;
                    void main() {
                        vec4 color = texture2D(uTexture, vUv);
                        if (color.a < 0.1) discard;
                        float shading = 0.9 + 0.1 * sin(vUv.x * 10.0); 
                        gl_FragColor = vec4(color.rgb * shading, color.a);
                    }
                `,
                side: THREE.DoubleSide,
                transparent: true
            });
        }

        function loadFlagTexture(code) {
            loadingOverlay.classList.remove('hidden');
            const url = `https://flagcdn.com/w1280/${code}.png`;
            textureLoader.load(url, (texture) => {
                texture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                const aspect = texture.image.width / texture.image.height;
                const h = 3.0;
                const w = h * aspect;
                if (flagMesh) {
                    flagMesh.geometry.dispose();
                    flagMesh.geometry = new THREE.PlaneGeometry(w, h, 64, 64);
                    flagMesh.material.uniforms.uTexture.value = texture;
                } else {
                    flagMaterial = createFlagMaterial(texture);
                    flagMesh = new THREE.Mesh(new THREE.PlaneGeometry(w, h, 64, 64), flagMaterial);
                    scene.add(flagMesh);
                }
                flagMesh.position.x = w / 2 - 2.5; 
                flagpole.position.x = -2.5 - 0.05;
                loadingOverlay.classList.add('hidden');
            }, undefined, (err) => {
                console.error("Flag loading error:", err);
                loadingOverlay.classList.add('hidden');
            });
        }

        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            if (flagMesh && flagMesh.material.uniforms) {
                const elapsed = clock.getElapsedTime();
                flagMesh.material.uniforms.uTime.value = elapsed;
                flagMesh.material.uniforms.uWindSpeed.value = simulationParams.windSpeed;
                flagMesh.material.uniforms.uWindAmplitude.value = simulationParams.windAmplitude;
                flagMesh.material.uniforms.uGravity.value = simulationParams.gravityStrength;
            }
            controls.update();
            renderer.render(scene, camera);
        }

        updateUI();
        loadFlagTexture(currentCountry.code);
        animate();
    </script>
</body>
</html>
